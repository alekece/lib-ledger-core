name: Continuous integration

on:
    push:
        path:
          - '**.cpp'
          - '**.hpp'
    pull_request:
        path:
          - '**.cpp'
          - '**.hpp'

jobs:
    build-ledger-core:
      name: Build ledger-core on ${{ matrix.os.alias }} in ${{ matrix.mode }} mode
      strategy:
        fail-fast: false
        matrix:
          os: [
            { name: ubuntu-latest, alias: linux, cache: { sbt: ~/.sbt, ivy: ~/.ivy2/cache }},
            { name: macOS-latest, alias: macos, cache: {sbt: ~/.sbt, ivy: ~/.ivy2/cache }}
            # { name: windows-latest, alias: windows }
          ]
          mode: [debug, release]
      runs-on: ${{ matrix.os.name }}
      steps:
        - name: Checkout repository
          uses: actions/checkout@v2
        - name: Install dependencies
          shell: bash
          run: .github/scripts/install_${{ matrix.os.alias}}_${{ matrix.mode }}_dependencies
        - name: Checkout submodules
          run: |
            git submodule init
            git submodule update --recursive
        # - name: Cache SBT ivy cache
        #   uses: actions/cache@v1
        #   with:
        #     path: ${{ matrix.os.cache.ivy }}
        #     key: ${{ runner.os }}-sbt-ivy-cache-${{ hashFiles('djinni/src/build.sbt') }}
        # - name: Cache SBT
        #   uses: actions/cache@v1
        #   with:
        #     path: ${{ matrix.os.cache.sbt }}
        #     key: ${{ runner.os }}-sbt-${{ hashFiles('djinni/src/build.sbt') }}
        - name: Generate interfaces
          shell: bash
          run: tools/lc api
        # - name: Configure CMake
        #   shell: bash
        #   run: scripts/configure_cmake.sh ${{ matrix.os.alias }} ${{ matrix.mode }}
        # - name: Build ledger-core
        #   working-directory: ledger-core/build
        #   run: make -j8
        # - name: Install ledger-core
        #   working-directory: ledger-core/build
        #   run: make install
        # - name: Test ledger-core
        #   working-directory: ledger-core/build
        #   run: make test

