name: Continuous integration

on:
    push:
        path:
          - '**.cpp'
          - '**.hpp'
    pull_request:
        path:
          - '**.cpp'
          - '**.hpp'

jobs:
    build-ledger-core:
      name: Build ledger-core on ${{ matrix.os.alias }} in ${{ matrix.mode }} mode
      strategy:
        fail-fast: false
        matrix:
          os: [
            { name: ubuntu-latest, alias: linux, dependency-directory: /usr/local },
            { name: macOS-latest, alias: macos, dependency-directory: /usr/local }
            # { name: windows-latest, alias: windows }
          ]
          mode: [debug, release]
      runs-on: ${{ matrix.os.name }}
      env:
        dependency-script: script/install_${{ matrix.os.alias}}_${{ matrix.mode }}_dependencies
      steps:
        - name: Checkout repository
          uses: actions/checkout@v2
        - name: Cache dependencies
          uses: actions/cache@v1
          id: dependency-cache
          with:
            path: ${{ matrix.os.dependency-directory }}
            key: ${{ runner.os }}-dependencies-${{ hashFiles('${{ env.dependency-script }}') }}
            restore-key: |
              ${{ runner.os }}-dependencies-
        - name: Install dependencies
          if: steps.dependency-cache.outputs.cache-hit != 'true'
          shell: bash
          run: ${{ env.dependency-script }}
        - name: Checkout submodules
          run: |
            git submodule init
            git submodule update --recursive
        # - name: Cache interfaces
        #   uses: actions/cache@v1
        #   with:
        #     path: ledger-core/inc/core/api/


        # - name: Generate interfaces
        #   shell: bash
        #   run: tools/lc api
        # - name: Configure CMake
        #   shell: bash
        #   run: scripts/configure_cmake.sh ${{ matrix.os.alias }} ${{ matrix.mode }}
        # - name: Build ledger-core
        #   working-directory: ledger-core/build
        #   run: make -j8
        # - name: Install ledger-core
        #   working-directory: ledger-core/build
        #   run: make install
        # - name: Test ledger-core
        #   working-directory: ledger-core/build
        #   run: make test

